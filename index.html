<!DOCTYPE html>
<html>
  <head>
    <script src="https://cdn.jsdelivr.net/npm/aframe@1.4.2/dist/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar/dist/mindar-image-aframe.prod.js"></script>
    <style>
      body, html { margin: 0; padding: 0; overflow: hidden; }
    </style>
  </head>
  <body>
    <a-scene mindar-image="imageTargetSrc: ./target.mind;" vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
      <a-assets>
        <a-asset-item id="model" src="https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models/2.0/Duck/glTF/Duck.gltf"></a-asset-item>
      </a-assets>

        <!-- Camera + Cursor - CHANGED: added fuse="true" for mobile -->
        <a-camera position="0 0 0">
            <a-cursor fuse="true" fuse-timeout="1500" raycaster="objects: .clickable"></a-cursor>
          </a-camera>

      <a-entity mindar-image-target="targetIndex: 0">
        <a-gltf-model rotation="0 0 0 " position="0 -0.25 0" scale="0.5 0.5 0.5" src="#model"></a-gltf-model>
        <!-- Button -->
        <a-plane class="clickable" 
                id="saveContactBtn"
                position="0 -0.6 0" 
                width="1" height="0.3" 
                color="blue" 
                text="value: Save Contact; align: center; color: white">
        </a-plane>
      </a-entity>
    </a-scene>
  </body>
  
  <script>
    const scene = document.querySelector('a-scene');
  
    scene.addEventListener('loaded', () => {
      const btn = document.querySelector("#saveContactBtn");
      const globalStatus = document.querySelector("#globalStatus");
      const arTarget = document.querySelector('a-entity[mindar-image-target]');
      
      globalStatus.setAttribute("value", "Scene loaded");
      
      // Track if target is visible
      let targetVisible = false;
      
      if (arTarget) {
        arTarget.addEventListener('targetFound', () => {
          globalStatus.setAttribute("value", "Target found - tap screen");
          targetVisible = true;
        });
        
        arTarget.addEventListener('targetLost', () => {
          globalStatus.setAttribute("value", "Target lost");
          targetVisible = false;
        });
      }
  
      function triggerDownload() {
        globalStatus.setAttribute("value", "Download starting...");
        
        if (btn) {
          btn.setAttribute("color", "green");
        }
  
        // Create vCard data
        const vCardData = `BEGIN:VCARD
VERSION:3.0
FN:Your Name
ORG:Your Company  
EMAIL:your.email@example.com
TEL:+1234567890
END:VCARD`;

        try {
          const blob = new Blob([vCardData], { type: 'text/vcard' });
          const url = URL.createObjectURL(blob);
          
          const a = document.createElement("a");
          a.href = url;
          a.download = "contact.vcf";
          a.style.display = 'none';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          
          globalStatus.setAttribute("value", "Download triggered!");
        } catch (error) {
          globalStatus.setAttribute("value", "Download failed");
        }
  
        // Reset after delay
        setTimeout(() => {
          if (btn) {
            btn.setAttribute("color", "blue");
          }
          globalStatus.setAttribute("value", "Ready - tap screen");
        }, 3000);
      }

      // CHANGED: Listen for ANY touch on the entire scene, not just button
      scene.addEventListener('touchstart', (e) => {
        e.preventDefault();
        globalStatus.setAttribute("value", "Touch detected!");
        
        // Only trigger download if target is visible
        if (targetVisible) {
          setTimeout(() => {
            triggerDownload();
          }, 100);
        }
      });

      // Also try click for desktop
      scene.addEventListener('click', (e) => {
        globalStatus.setAttribute("value", "Click detected!");
        if (targetVisible) {
          triggerDownload();
        }
      });
    });
  </script>
  
  </html>